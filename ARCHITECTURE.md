# Архитектура системы EduSchedule

## Обзор системы

EduSchedule - это многофункциональная система управления расписанием для образовательных учреждений с поддержкой мультитенантности.

## Структура пользователей

### 1. Студенты
- **Путь**: `/` → Выбор города → Выбор учреждения → Выбор филиала → Просмотр расписания группы
- **Функции**:
  - Выбор города обучения
  - Поиск и выбор учебного заведения (университет/колледж/школа)
  - Выбор филиала (если их несколько)
  - Поиск своей группы
  - Просмотр расписания на неделю (нечетная/четная)
  - Детальная информация о занятиях

### 2. Представители организаций (Супер-админы)
- **Путь**: `/register` → Регистрация организации
- **Регистрационные данные**:
  - Тип учреждения (университет/колледж/школа)
  - Название организации
  - Город
  - Email администратора
  - Пароль
- **После регистрации**: Доступ к панели управления организацией

### 3. Администраторы организаций
- **Путь**: `/org-admin/branches` → Панель управления
- **Функции**:
  - **Управление филиалами** (`/org-admin/branches`):
    - Создание/редактирование/удаление филиалов
    - Активация/деактивация филиалов
    - Управление контактной информацией
  - **Просмотр расписания** (`/viewer`):
    - Поиск по группам, преподавателям, аудиториям
    - Экспорт расписания
  - **Редактор расписания** (`/admin`):
    - Drag & Drop интерфейс для создания расписания
    - Автоматическое определение конфликтов
    - Управление занятиями
  - **Справочники** (`/data`):
    - Управление группами
    - Управление преподавателями
    - Управление аудиториями
    - Управление предметами
  - **Аналитика** (`/analytics`):
    - Загруженность аудиторий
    - Нагрузка преподавателей
    - Статистика по типам занятий
  - **Настройки** (`/settings`):
    - Временные слоты
    - Темная/светлая тема
    - Системные параметры

## Backend (NestJS + PostgreSQL)

- **Стек**: Node.js 20, NestJS 11, Prisma ORM, PostgreSQL 16, Passport.js (Local + JWT).
- **Валидация**: `class-validator`/`class-transformer` во всех DTO.
- **Контейнеризация**: Docker Compose (`postgres` + `pgadmin`). В репозитории есть `docker-compose.yml`; при отсутствии Docker можно использовать любой PostgreSQL и передавать `DATABASE_URL`.
- **Модули**:
  - `AuthModule`: регистрация организации, вход по email+паролю, JWT токены.
  - `UsersModule`: хранение ролей (`super_admin`, `org_admin`, `editor`, `viewer`) и привязка к организации/филиалу.
  - `OrganizationsModule`: CRUD для организаций, изменение статуса и срока подписки.
  - `BranchesModule`: создание/редактирование/удаление филиалов с типами (университет/колледж/школа).
  - `SchedulesModule`: управление версиями расписаний (шаблон/на период), контроль конфликтов дат, копирование шаблонов.
  - `PrismaModule`: единая точка доступа к базе; сервис расширяет `PrismaClient` и подключается при старте.
  - `PublicModule`: открытые эндпоинты (`/public/cities`, `/public/organizations`, `/public/branches`, `/public/schedules`) для студенческого сценария без авторизации.
- **Безопасность**:
  - Local стратегия для проверки логина/пароля.
  - JWT стратегия для всех защищённых эндпоинтов.
  - Декоратор `@Roles()` + guard для ограничения доступа к административным маршрутам.
  - Санитизация пользователя (хеш пароля не выходит наружу).
- **Основные эндпоинты**:
  - `POST /api/auth/register` – создаёт организацию, дефолтный филиал и администратора.
  - `POST /api/auth/login` – выдаёт JWT.
  - `GET /api/organizations`, `/api/branches`, `/api/schedules` – выборки с фильтрами.
  - `POST /api/schedules` – создаёт расписание. Для типа `PERIOD` проверяются даты и отсутствие пересечений.
  - `POST /api/schedules/:id/duplicate` – быстрая копия расписания.
- **Миграции и БД**:
  - Prisma схема (`server/prisma/schema.prisma`) описывает модели `Organization`, `Branch`, `User`, `ScheduleVersion` и перечисления дней недели.
  - Скрипты: `npm run prisma:generate`, `npm run prisma:migrate`, `npm run prisma:studio`.
  - Конфигурация окружения хранится в `server/env.example`; реальные значения копируются в `.env`.
- **Запуск**:
  1. `docker compose up -d postgres` (или собственный Postgres).
  2. `cd server && npm install`.
  3. `cp env.example .env` и заполнить `DATABASE_URL`, `JWT_SECRET`.
  4. `npm run prisma:migrate`.
  5. `npm run start:dev` — API доступно на `http://localhost:4000/api`.
- **Тестирование**: Jest покрывает критичную бизнес-логику (например, запрет расписаний с пересекающимися периодами).

## Frontend Data Flow

- **AuthContext** + `useAuth`: хранение токена и данных пользователя, автоматическая подстановка `Authorization` заголовка.
- **REST-клиент** (`src/api/*`): типизированные функции для `/auth`, `/branches`, `/schedules` и публичных эндпоинтов.
- **Student flow**: город/организация/филиал запрашиваются через `/public/*`, данные сохраняются в `localStorage`.
- **Admin flow**: экраны `BranchManagementPage` и `ScheduleManagementPage` работают с реальными данными из API вместо моков (создание/редактирование/удаление, валидация форм).

## Модель данных

### Организация (Organization)
```typescript
{
  id: string;
  name: string;
  email: string;
  type: 'university' | 'college' | 'school';
  city: string;
  createdAt: Date;
  isActive: boolean;
  subscriptionEndDate?: Date;
}
```

### Филиал (Branch)
```typescript
{
  id: string;
  organizationId: string;
  name: string;
  city: string;
  address: string;
  contactEmail?: string;
  contactPhone?: string;
  isActive: boolean;
  createdAt: Date;
}
```

### Группа (Group)
```typescript
{
  id: string;
  name: string;
  course: number;
  faculty: string;
  studentCount: number;
  organizationId: string;
  branchId: string;
}
```

## Маршруты приложения

### Публичные маршруты (студенты)
- `/` - Выбор города
- `/student/organization-selection?city={cityId}` - Выбор учреждения
- `/student/branch-selection?org={orgId}` - Выбор филиала
- `/student/schedule` - Просмотр расписания группы

### Регистрация
- `/register` - Регистрация организации

### Административные маршруты (с боковой панелью)
- `/org-admin/branches` - Управление филиалами
- `/viewer` - Просмотр расписания
- `/admin` - Редактор расписания
- `/data` - Справочники
- `/analytics` - Аналитика
- `/settings` - Настройки

## Бизнес-модель

### Концепция
Организации (университеты, колледжи, школы) покупают доступ к сервису EduSchedule для удобного отображения расписания своим студентам.

### Процесс
1. Представитель организации регистрируется на платформе
2. Создает филиалы своей организации
3. Добавляет группы, преподавателей, аудитории
4. Создает и публикует расписание
5. Студенты находят свою организацию через публичный поиск и просматривают расписание

### Преимущества
- **Для организаций**:
  - Централизованное управление расписанием
  - Поддержка множества филиалов
  - Автоматическое определение конфликтов
  - Детальная аналитика
  - Современный интерфейс

- **Для студентов**:
  - Быстрый доступ к расписанию
  - Адаптивный дизайн (работает на всех устройствах)
  - Детальная информация о занятиях
  - Темная/светлая тема

## Технологический стек

### Frontend
- **React 19** - UI библиотека
- **TypeScript** - Типизация
- **Vite 7.2** - Сборщик
- **React Router v7** - Маршрутизация
- **Tailwind CSS v3.4** - Стилизация

### Библиотеки
- **@dnd-kit** - Drag & Drop
- **Recharts** - Графики и диаграммы
- **date-fns** - Работа с датами
- **Lucide React** - Иконки

## Развертывание

### Сборка проекта
```bash
npm run build
```

### Запуск dev сервера
```bash
npm run dev
```

### Деплой на Vercel
Проект настроен для автоматического деплоя на Vercel:
- `vercel.json` - конфигурация
- `.vercelignore` - исключаемые файлы

## Дальнейшее развитие

### Планируемые функции
1. **Аутентификация**:
   - JWT токены
   - Роли и права доступа
   - Восстановление пароля

2. **Backend интеграция**:
   - REST API / GraphQL
   - База данных (PostgreSQL)
   - Файловое хранилище

3. **Расширенные функции**:
   - Уведомления об изменениях в расписании
   - Экспорт в различные форматы (PDF, iCal, Excel)
   - Мобильное приложение
   - Интеграция с календарями
   - История изменений
   - Комментарии к занятиям

4. **Аналитика**:
   - Дашборд для супер-админа
   - Статистика использования
   - Метрики производительности

5. **Биллинг**:
   - Подписки
   - Тарифные планы
   - Оплата через Stripe/ЮKassa

## Лицензия

Проприетарное ПО

